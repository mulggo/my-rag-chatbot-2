{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# 02. Bedrock í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„\n",
    "\n",
    "AWS Bedrockê³¼ Knowledge Baseë¥¼ í™œìš©í•œ RAG ì‹œìŠ¤í…œì˜ í•µì‹¬ í´ë¼ì´ì–¸íŠ¸ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.\n",
    "\n",
    "## ğŸ“‹ êµ¬í˜„ ëª©í‘œ\n",
    "1. Bedrock í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”\n",
    "2. RetrieveAndGenerate API í˜¸ì¶œ\n",
    "3. ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…\n",
    "4. ì‘ë‹µ íŒŒì‹± ë° í¬ë§·íŒ…"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 1. í™˜ê²½ ì„¤ì • ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ import"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì™„ë£Œ\n"
     ]
    }
   ],
   "source": [
    "import boto3\n",
    "import json\n",
    "import os\n",
    "from typing import Dict, List, Optional, Any\n",
    "from botocore.exceptions import ClientError\n",
    "import logging\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "\n",
    "# .env íŒŒì¼ ë¡œë“œ\n",
    "load_dotenv()\n",
    "\n",
    "# ë¡œê¹… ì„¤ì •\n",
    "logging.basicConfig(level=logging.INFO)\n",
    "logger = logging.getLogger(__name__)\n",
    "\n",
    "print(\"âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì™„ë£Œ\")\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 2. í™˜ê²½ ë³€ìˆ˜ í™•ì¸"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸŒ AWS Region: us-west-2\n",
      "ğŸ§  Knowledge Base ID: CSCXXZALGC\n",
      "ğŸ¤– Model ID: anthropic.claude-3-7-sonnet-20250219-v1:0\n",
      "âœ… í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ!\n"
     ]
    }
   ],
   "source": [
    "# í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°\n",
    "region = os.environ.get('AWS_REGION', 'us-west-2')\n",
    "#kb_id = 'my-rag-kb-da2f0737'\n",
    "kb_id = os.environ.get('BEDROCK_KNOWLEDGE_BASE_ID')\n",
    "model_id = os.environ.get('BEDROCK_MODEL_ID', 'anthropic.claude-3-haiku-20240307-v1:0')\n",
    "\n",
    "print(f\"ğŸŒ AWS Region: {region}\")\n",
    "print(f\"ğŸ§  Knowledge Base ID: {kb_id}\")\n",
    "print(f\"ğŸ¤– Model ID: {model_id}\")\n",
    "\n",
    "if not kb_id:\n",
    "    print(\"âš ï¸ BEDROCK_KNOWLEDGE_BASE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\")\n",
    "    print(\"01_aws_setup.ipynbì˜ 8ë²ˆ ì„¹ì…˜ì„ ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\")\n",
    "else:\n",
    "    print(\"âœ… í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 3. Bedrock í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤ êµ¬í˜„"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… BedrockClient í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ\n"
     ]
    }
   ],
   "source": [
    "class BedrockClient:\n",
    "    \"\"\"AWS Bedrockì„ í™œìš©í•œ RAG í´ë¼ì´ì–¸íŠ¸\"\"\"\n",
    "    \n",
    "    def __init__(self, region_name: str = 'us-west-2', knowledge_base_id: str = None, model_id: str = None):\n",
    "        \"\"\"\n",
    "        Bedrock í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”\n",
    "        \n",
    "        Args:\n",
    "            region_name: AWS ë¦¬ì „\n",
    "            knowledge_base_id: Bedrock Knowledge Base ID\n",
    "            model_id: ì‚¬ìš©í•  Foundation Model ID\n",
    "        \"\"\"\n",
    "        self.region_name = region_name\n",
    "        self.knowledge_base_id = knowledge_base_id\n",
    "        self.model_id = model_id or 'anthropic.claude-3-7-sonnet-20250219-v1:0'\n",
    "        \n",
    "        # Bedrock Agent Runtime í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”\n",
    "        try:\n",
    "            self.bedrock_agent_runtime = boto3.client(\n",
    "                'bedrock-agent-runtime',\n",
    "                region_name=self.region_name\n",
    "            )\n",
    "            logger.info(f\"âœ… Bedrock Agent Runtime í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ (Region: {self.region_name})\")\n",
    "        except Exception as e:\n",
    "            logger.error(f\"âŒ Bedrock í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}\")\n",
    "            raise\n",
    "    \n",
    "    def retrieve_and_generate(self, query: str, session_id: str = None) -> Dict[str, Any]:\n",
    "        \"\"\"\n",
    "        Knowledge Baseë¥¼ í™œìš©í•œ RAG ê²€ìƒ‰ ë° ë‹µë³€ ìƒì„±\n",
    "        \n",
    "        Args:\n",
    "            query: ì‚¬ìš©ì ì§ˆë¬¸\n",
    "            session_id: ëŒ€í™” ì„¸ì…˜ ID (ì„ íƒì‚¬í•­)\n",
    "            \n",
    "        Returns:\n",
    "            Dict containing response, sources, and metadata\n",
    "        \"\"\"\n",
    "        if not self.knowledge_base_id:\n",
    "            raise ValueError(\"Knowledge Base IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\")\n",
    "        \n",
    "        try:\n",
    "            # RetrieveAndGenerate API í˜¸ì¶œ íŒŒë¼ë¯¸í„° êµ¬ì„±\n",
    "            params = {\n",
    "                'input': {\n",
    "                    'text': query\n",
    "                },\n",
    "                'retrieveAndGenerateConfiguration': {\n",
    "                    'type': 'KNOWLEDGE_BASE',\n",
    "                    'knowledgeBaseConfiguration': {\n",
    "                        'knowledgeBaseId': self.knowledge_base_id,\n",
    "                        'modelArn': f'arn:aws:bedrock:{self.region_name}::foundation-model/{self.model_id}',\n",
    "                        'retrievalConfiguration': {\n",
    "                            'vectorSearchConfiguration': {\n",
    "                                'numberOfResults': 5,\n",
    "                                'overrideSearchType': 'HYBRID'\n",
    "                            }\n",
    "                        }\n",
    "                    }\n",
    "                }\n",
    "            }\n",
    "            \n",
    "            # ì„¸ì…˜ IDê°€ ìˆìœ¼ë©´ ì¶”ê°€\n",
    "            if session_id:\n",
    "                params['sessionId'] = session_id\n",
    "            \n",
    "            logger.info(f\"ğŸ” Knowledge Base ê²€ìƒ‰ ì‹œì‘: {query[:50]}...\")\n",
    "            \n",
    "            # API í˜¸ì¶œ\n",
    "            response = self.bedrock_agent_runtime.retrieve_and_generate(**params)\n",
    "            \n",
    "            # ì‘ë‹µ íŒŒì‹±\n",
    "            result = self._parse_response(response)\n",
    "            \n",
    "            logger.info(f\"âœ… ê²€ìƒ‰ ì™„ë£Œ: {len(result.get('sources', []))}ê°œ ì†ŒìŠ¤ ë°œê²¬\")\n",
    "            \n",
    "            return result\n",
    "            \n",
    "        except ClientError as e:\n",
    "            error_code = e.response['Error']['Code']\n",
    "            error_message = e.response['Error']['Message']\n",
    "            logger.error(f\"âŒ Bedrock API ì˜¤ë¥˜ [{error_code}]: {error_message}\")\n",
    "            \n",
    "            return {\n",
    "                'answer': f\"ì£„ì†¡í•©ë‹ˆë‹¤. ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error_message}\",\n",
    "                'sources': [],\n",
    "                'session_id': session_id,\n",
    "                'error': True,\n",
    "                'error_code': error_code\n",
    "            }\n",
    "            \n",
    "        except Exception as e:\n",
    "            logger.error(f\"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}\")\n",
    "            \n",
    "            return {\n",
    "                'answer': f\"ì£„ì†¡í•©ë‹ˆë‹¤. ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\",\n",
    "                'sources': [],\n",
    "                'session_id': session_id,\n",
    "                'error': True\n",
    "            }\n",
    "    \n",
    "    def _parse_response(self, response: Dict[str, Any]) -> Dict[str, Any]:\n",
    "        \"\"\"\n",
    "        Bedrock ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ êµ¬ì¡°í™”ëœ ê²°ê³¼ ë°˜í™˜\n",
    "        \n",
    "        Args:\n",
    "            response: Bedrock API ì›ë³¸ ì‘ë‹µ\n",
    "            \n",
    "        Returns:\n",
    "            íŒŒì‹±ëœ ì‘ë‹µ ë°ì´í„°\n",
    "        \"\"\"\n",
    "        try:\n",
    "            # ê¸°ë³¸ ì‘ë‹µ ì¶”ì¶œ\n",
    "            output = response.get('output', {})\n",
    "            answer = output.get('text', 'ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')\n",
    "            \n",
    "            # ì†ŒìŠ¤ ì •ë³´ ì¶”ì¶œ\n",
    "            sources = []\n",
    "            citations = response.get('citations', [])\n",
    "            \n",
    "            for citation in citations:\n",
    "                retrieved_references = citation.get('retrievedReferences', [])\n",
    "                \n",
    "                for ref in retrieved_references:\n",
    "                    source_info = {\n",
    "                        'content': ref.get('content', {}).get('text', ''),\n",
    "                        'location': ref.get('location', {}),\n",
    "                        'metadata': ref.get('metadata', {})\n",
    "                    }\n",
    "                    \n",
    "                    # S3 URIì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ\n",
    "                    s3_uri = source_info['location'].get('s3Location', {}).get('uri', '')\n",
    "                    if s3_uri:\n",
    "                        source_info['filename'] = s3_uri.split('/')[-1]\n",
    "                    \n",
    "                    sources.append(source_info)\n",
    "            \n",
    "            return {\n",
    "                'answer': answer,\n",
    "                'sources': sources,\n",
    "                'session_id': response.get('sessionId'),\n",
    "                'timestamp': datetime.now().isoformat(),\n",
    "                'error': False\n",
    "            }\n",
    "            \n",
    "        except Exception as e:\n",
    "            logger.error(f\"âŒ ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: {e}\")\n",
    "            return {\n",
    "                'answer': 'ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',\n",
    "                'sources': [],\n",
    "                'session_id': None,\n",
    "                'error': True\n",
    "            }\n",
    "    \n",
    "    def get_knowledge_base_info(self) -> Dict[str, Any]:\n",
    "        \"\"\"\n",
    "        í˜„ì¬ ì„¤ì •ëœ Knowledge Base ì •ë³´ ë°˜í™˜\n",
    "        \n",
    "        Returns:\n",
    "            Knowledge Base ì„¤ì • ì •ë³´\n",
    "        \"\"\"\n",
    "        return {\n",
    "            'knowledge_base_id': self.knowledge_base_id,\n",
    "            'model_id': self.model_id,\n",
    "            'region': self.region_name\n",
    "        }\n",
    "\n",
    "print(\"âœ… BedrockClient í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 4. í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° í…ŒìŠ¤íŠ¸"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:__main__:âœ… Bedrock Agent Runtime í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ (Region: us-west-2)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… BedrockClient ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ\n",
      "\n",
      "ğŸ“‹ í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ì •ë³´:\n",
      "  knowledge_base_id: CSCXXZALGC\n",
      "  model_id: anthropic.claude-3-7-sonnet-20250219-v1:0\n",
      "  region: us-west-2\n"
     ]
    }
   ],
   "source": [
    "# Bedrock í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\n",
    "try:\n",
    "    bedrock_client = BedrockClient(\n",
    "        region_name=region,\n",
    "        knowledge_base_id=kb_id,\n",
    "        model_id=model_id\n",
    "    )\n",
    "    \n",
    "    print(\"âœ… BedrockClient ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ\")\n",
    "    \n",
    "    # ì„¤ì • ì •ë³´ ì¶œë ¥\n",
    "    info = bedrock_client.get_knowledge_base_info()\n",
    "    print(\"\\nğŸ“‹ í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ì •ë³´:\")\n",
    "    for key, value in info.items():\n",
    "        print(f\"  {key}: {value}\")\n",
    "        \n",
    "except Exception as e:\n",
    "    print(f\"âŒ í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨: {e}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 5. í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì—…ë¡œë“œ ë° Knowledge Base ë™ê¸°í™”"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import time\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìƒì„± ë° ì—…ë¡œë“œ\n",
    "def create_and_upload_test_documents():\n",
    "    \"\"\"í…ŒìŠ¤íŠ¸ìš© ë¬¸ì„œë“¤ì„ ìƒì„±í•˜ê³  S3ì— ì—…ë¡œë“œ\"\"\"\n",
    "    \n",
    "    # í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ë‚´ìš©\n",
    "    test_documents = {\n",
    "        'rag_system_guide.txt': '''\n",
    "# RAG (Retrieval-Augmented Generation) ì‹œìŠ¤í…œ ê°€ì´ë“œ\n",
    "\n",
    "## RAGë€ ë¬´ì—‡ì¸ê°€?\n",
    "RAGëŠ” ê²€ìƒ‰ ì¦ê°• ìƒì„±(Retrieval-Augmented Generation)ì˜ ì¤„ì„ë§ë¡œ, ì™¸ë¶€ ì§€ì‹ ë² ì´ìŠ¤ì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ ê²€ìƒ‰í•œ í›„ ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” AI ì‹œìŠ¤í…œì…ë‹ˆë‹¤.\n",
    "\n",
    "## RAGì˜ ì£¼ìš” ì¥ì \n",
    "1. **ìµœì‹  ì •ë³´ í™œìš©**: ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ” ì™¸ë¶€ ë°ì´í„° í™œìš© ê°€ëŠ¥\n",
    "2. **ì •í™•ì„± í–¥ìƒ**: ê²€ì¦ëœ ì†ŒìŠ¤ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë‹µë³€ ìƒì„±\n",
    "3. **íˆ¬ëª…ì„±**: ë‹µë³€ì˜ ê·¼ê±°ê°€ ë˜ëŠ” ì†ŒìŠ¤ ë¬¸ì„œ ì œê³µ\n",
    "4. **ë„ë©”ì¸ íŠ¹í™”**: íŠ¹ì • ë¶„ì•¼ì˜ ì „ë¬¸ ì§€ì‹ í™œìš© ê°€ëŠ¥\n",
    "\n",
    "## RAG ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ\n",
    "- **ë¬¸ì„œ ì €ì¥ì†Œ**: S3, ë°ì´í„°ë² ì´ìŠ¤ ë“±\n",
    "- **ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤**: OpenSearch, Pinecone ë“±\n",
    "- **ì„ë² ë”© ëª¨ë¸**: í…ìŠ¤íŠ¸ë¥¼ ë²¡í„°ë¡œ ë³€í™˜\n",
    "- **ìƒì„± ëª¨ë¸**: Claude, GPT ë“± LLM\n",
    "''',\n",
    "        \n",
    "        'aws_bedrock_features.txt': '''\n",
    "# AWS Bedrock ì£¼ìš” ê¸°ëŠ¥\n",
    "\n",
    "## Foundation Models\n",
    "AWS Bedrockì€ ë‹¤ì–‘í•œ Foundation Modelì„ ì œê³µí•©ë‹ˆë‹¤:\n",
    "- **Anthropic Claude**: ëŒ€í™”í˜• AI, ê¸´ ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬\n",
    "- **Amazon Titan**: í…ìŠ¤íŠ¸ ìƒì„± ë° ì„ë² ë”©\n",
    "- **Cohere**: í…ìŠ¤íŠ¸ ìƒì„± ë° ë¶„ë¥˜\n",
    "- **Meta Llama**: ì˜¤í”ˆì†ŒìŠ¤ ê¸°ë°˜ ëª¨ë¸\n",
    "\n",
    "## Knowledge Base\n",
    "- **ìë™ ë¬¸ì„œ ì²˜ë¦¬**: PDF, í…ìŠ¤íŠ¸, ì´ë¯¸ì§€ ë“± ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›\n",
    "- **ë²¡í„° ê²€ìƒ‰**: ì˜ë¯¸ ê¸°ë°˜ ë¬¸ì„œ ê²€ìƒ‰\n",
    "- **ë©€í‹°ëª¨ë‹¬ ì§€ì›**: í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ì²˜ë¦¬\n",
    "\n",
    "## ë³´ì•ˆ ë° ê·œì • ì¤€ìˆ˜\n",
    "- **ë°ì´í„° í”„ë¼ì´ë²„ì‹œ**: ê³ ê° ë°ì´í„°ëŠ” ëª¨ë¸ í•™ìŠµì— ì‚¬ìš©ë˜ì§€ ì•ŠìŒ\n",
    "- **ì•”í˜¸í™”**: ì „ì†¡ ì¤‘ ë° ì €ì¥ ì‹œ ë°ì´í„° ì•”í˜¸í™”\n",
    "- **IAM í†µí•©**: ì„¸ë°€í•œ ê¶Œí•œ ê´€ë¦¬\n",
    "''',\n",
    "        \n",
    "        'multimodal_processing.txt': '''\n",
    "# ë©€í‹°ëª¨ë‹¬ ë¬¸ì„œ ì²˜ë¦¬\n",
    "\n",
    "## ì§€ì› íŒŒì¼ í˜•ì‹\n",
    "- **í…ìŠ¤íŠ¸**: .txt, .md, .csv\n",
    "- **ë¬¸ì„œ**: .pdf, .docx\n",
    "- **ì´ë¯¸ì§€**: .jpg, .jpeg, .png\n",
    "\n",
    "## ì²˜ë¦¬ ê³¼ì •\n",
    "1. **íŒŒì¼ ì—…ë¡œë“œ**: S3 ë²„í‚·ì— ë¬¸ì„œ ì €ì¥\n",
    "2. **íŒŒì‹±**: Claude ëª¨ë¸ì„ ì‚¬ìš©í•œ ë©€í‹°ëª¨ë‹¬ íŒŒì‹±\n",
    "3. **ì²­í‚¹**: ê³„ì¸µí˜• ì²­í‚¹ìœ¼ë¡œ ë¬¸ì„œ ë¶„í• \n",
    "4. **ì„ë² ë”©**: Titan ëª¨ë¸ë¡œ ë²¡í„° ë³€í™˜\n",
    "5. **ì¸ë±ì‹±**: OpenSearchì— ë²¡í„° ì €ì¥\n",
    "\n",
    "## ìµœì í™” íŒ\n",
    "- ì´ë¯¸ì§€ëŠ” ê³ í•´ìƒë„ë³´ë‹¤ í…ìŠ¤íŠ¸ê°€ ëª…í™•í•œ ê²ƒì´ ì¤‘ìš”\n",
    "- PDFëŠ” í…ìŠ¤íŠ¸ ê¸°ë°˜ì´ OCRë³´ë‹¤ ì •í™•\n",
    "- ë¬¸ì„œ êµ¬ì¡°ë¥¼ ëª…í™•íˆ í•˜ë©´ ì²­í‚¹ í’ˆì§ˆ í–¥ìƒ\n",
    "'''\n",
    "    }\n",
    "    \n",
    "    print(\"ğŸ“„ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìƒì„± ë° ì—…ë¡œë“œ ì‹œì‘...\")\n",
    "    \n",
    "    uploaded_files = []\n",
    "    \n",
    "    for filename, content in test_documents.items():\n",
    "        try:\n",
    "            # S3ì— ì—…ë¡œë“œ\n",
    "            s3_client.put_object(\n",
    "                Bucket=s3_bucket_name,\n",
    "                Key=f'documents/{filename}',\n",
    "                Body=content.encode('utf-8'),\n",
    "                ContentType='text/plain'\n",
    "            )\n",
    "            uploaded_files.append(filename)\n",
    "            print(f\"âœ… {filename} ì—…ë¡œë“œ ì™„ë£Œ\")\n",
    "            \n",
    "        except Exception as e:\n",
    "            print(f\"âŒ {filename} ì—…ë¡œë“œ ì‹¤íŒ¨: {e}\")\n",
    "    \n",
    "    print(f\"\\nğŸ“Š ì´ {len(uploaded_files)}ê°œ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì—…ë¡œë“œ ì™„ë£Œ\")\n",
    "    return uploaded_files\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì—…ë¡œë“œ ì‹¤í–‰\n",
    "test_files = create_and_upload_test_documents()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Knowledge Base ë™ê¸°í™” (ë°ì´í„° ì†ŒìŠ¤ ingestion)\n",
    "def sync_knowledge_base(kb_id, data_source_id):\n",
    "    \"\"\"Knowledge Baseì™€ S3 ë°ì´í„° ì†ŒìŠ¤ ë™ê¸°í™”\"\"\"\n",
    "    try:\n",
    "        print(\"ğŸ”„ Knowledge Base ë™ê¸°í™” ì‹œì‘...\")\n",
    "        \n",
    "        # Ingestion Job ì‹œì‘\n",
    "        response = bedrock_agent_client.start_ingestion_job(\n",
    "            knowledgeBaseId=kb_id,\n",
    "            dataSourceId=data_source_id,\n",
    "            description='Test documents ingestion'\n",
    "        )\n",
    "        \n",
    "        job_id = response['ingestionJob']['ingestionJobId']\n",
    "        print(f\"ğŸ“‹ Ingestion Job ID: {job_id}\")\n",
    "        \n",
    "        # Job ìƒíƒœ ëª¨ë‹ˆí„°ë§\n",
    "        print(\"â³ ë™ê¸°í™” ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§...\")\n",
    "        \n",
    "        while True:\n",
    "            job_status = bedrock_agent_client.get_ingestion_job(\n",
    "                knowledgeBaseId=kb_id,\n",
    "                dataSourceId=data_source_id,\n",
    "                ingestionJobId=job_id\n",
    "            )\n",
    "            \n",
    "            status = job_status['ingestionJob']['status']\n",
    "            print(f\"ğŸ“Š ìƒíƒœ: {status}\")\n",
    "            \n",
    "            if status == 'COMPLETE':\n",
    "                print(\"âœ… Knowledge Base ë™ê¸°í™” ì™„ë£Œ!\")\n",
    "                \n",
    "                # í†µê³„ ì •ë³´ ì¶œë ¥\n",
    "                stats = job_status['ingestionJob'].get('statistics', {})\n",
    "                if stats:\n",
    "                    print(f\"ğŸ“ˆ ì²˜ë¦¬ëœ ë¬¸ì„œ: {stats.get('numberOfDocumentsScanned', 0)}ê°œ\")\n",
    "                    print(f\"ğŸ“ˆ ìƒì„±ëœ ì²­í¬: {stats.get('numberOfNewDocumentsIndexed', 0)}ê°œ\")\n",
    "                \n",
    "                return True\n",
    "                \n",
    "            elif status == 'FAILED':\n",
    "                print(\"âŒ Knowledge Base ë™ê¸°í™” ì‹¤íŒ¨\")\n",
    "                failure_reasons = job_status['ingestionJob'].get('failureReasons', [])\n",
    "                for reason in failure_reasons:\n",
    "                    print(f\"   - {reason}\")\n",
    "                return False\n",
    "                \n",
    "            elif status in ['IN_PROGRESS', 'STARTING']:\n",
    "                time.sleep(10)  # 10ì´ˆ ëŒ€ê¸°\n",
    "            else:\n",
    "                print(f\"âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ìƒíƒœ: {status}\")\n",
    "                time.sleep(5)\n",
    "                \n",
    "    except Exception as e:\n",
    "        print(f\"âŒ ë™ê¸°í™” ì˜¤ë¥˜: {e}\")\n",
    "        return False\n",
    "\n",
    "# Knowledge Base ë™ê¸°í™” ì‹¤í–‰\n",
    "if kb_id and data_source_id:\n",
    "    sync_success = sync_knowledge_base(kb_id, data_source_id)\n",
    "    if sync_success:\n",
    "        print(\"\\nğŸ‰ í…ŒìŠ¤íŠ¸ ë¬¸ì„œê°€ Knowledge Baseì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\")\n",
    "    else:\n",
    "        print(\"\\nâš ï¸ ë™ê¸°í™”ì— ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\")\n",
    "else:\n",
    "    print(\"âŒ Knowledge Base ID ë˜ëŠ” Data Source IDê°€ ì—†ìŠµë‹ˆë‹¤.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 6. Knowledge Base í…ŒìŠ¤íŠ¸ ë° ì •ë¦¬"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [\n",
    "        print(f\"ğŸ“š ì°¸ì¡° ì†ŒìŠ¤ ({len(result['sources'])}ê°œ):\")\n",
    "        for i, source in enumerate(result['sources'][:3], 1):  # ìƒìœ„ 3ê°œë§Œ í‘œì‹œ\n",
    "            filename = source.get('filename', 'Unknown')\n",
    "            content_preview = source.get('content', '')[:100] + '...' if len(source.get('content', '')) > 100 else source.get('content', '')\n",
    "            print(f\"  {i}. {filename}\")\n",
    "            print(f\"     {content_preview}\\n\")\n",
    "    else:\n",
    "        print(\"ğŸ“š ì°¸ì¡° ì†ŒìŠ¤: ì—†ìŒ\")\n",
    "        \n",
    "    if result.get('error'):\n",
    "        print(f\"âš ï¸ ì˜¤ë¥˜ ë°œìƒ: {result.get('error_code', 'Unknown')}\")\n",
    "        \n",
    "else:\n",
    "    print(\"âš ï¸ Knowledge Base IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.\")\n",
    "    print(\"01_aws_setup.ipynbë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 6. Knowledge Base í…ŒìŠ¤íŠ¸ ë° ì •ë¦¬"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:__main__:ğŸ” Knowledge Base ê²€ìƒ‰ ì‹œì‘: RAG ì‹œìŠ¤í…œì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”....\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ‘¤ ì§ˆë¬¸ 1: RAG ì‹œìŠ¤í…œì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:__main__:âœ… ê²€ìƒ‰ ì™„ë£Œ: 0ê°œ ì†ŒìŠ¤ ë°œê²¬\n",
      "INFO:__main__:ğŸ” Knowledge Base ê²€ìƒ‰ ì‹œì‘: ê·¸ê²ƒì˜ ì¥ì ì€ ë¬´ì—‡ì¸ê°€ìš”?...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ¤– ë‹µë³€ 1: Sorry, I am unable to assist you with this request....\n",
      "ğŸ”— ì„¸ì…˜ ID ìƒì„±ë¨: 103da42e-b6eb-4506-928a-cb17708d835d\n",
      "\n",
      "ğŸ‘¤ ì§ˆë¬¸ 2: ê·¸ê²ƒì˜ ì¥ì ì€ ë¬´ì—‡ì¸ê°€ìš”?\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "ERROR:__main__:âŒ Bedrock API ì˜¤ë¥˜ [ValidationException]: Invocation of model ID anthropic.claude-3-7-sonnet-20250219-v1:0 with on-demand throughput isnâ€™t supported. Retry your request with the ID or ARN of an inference profile that contains this model. (Service: BedrockRuntime, Status Code: 400, Request ID: 3c1ce76e-beda-4644-b2f5-158d55447db7) (SDK Attempt Count: 1)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ¤– ë‹µë³€ 2: ì£„ì†¡í•©ë‹ˆë‹¤. ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: Invocation of model ID anthropic.claude-3-7-sonnet-20250219-v1:0 with on-demand throughput isnâ€™t supported. Retry your request with the ID or ARN of an inference profile that c...\n",
      "\n",
      "âœ… ëŒ€í™” ì„¸ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n"
     ]
    }
   ],
   "source": [
    "if kb_id:\n",
    "    # ì²« ë²ˆì§¸ ì§ˆë¬¸ (ì„¸ì…˜ ID ì—†ì´ ì‹œì‘)\n",
    "    query1 = \"RAG ì‹œìŠ¤í…œì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.\"\n",
    "    print(f\"ğŸ‘¤ ì§ˆë¬¸ 1: {query1}\")\n",
    "    \n",
    "    # ì„¸ì…˜ ID ì—†ì´ ì²« ë²ˆì§¸ í˜¸ì¶œ\n",
    "    result1 = bedrock_client.retrieve_and_generate(query1)\n",
    "    print(f\"ğŸ¤– ë‹µë³€ 1: {result1['answer'][:200]}...\")\n",
    "    \n",
    "    # ì‘ë‹µì—ì„œ ì„¸ì…˜ ID ì¶”ì¶œ\n",
    "    session_id = result1.get('session_id')\n",
    "    if session_id:\n",
    "        print(f\"ğŸ”— ì„¸ì…˜ ID ìƒì„±ë¨: {session_id}\\n\")\n",
    "        \n",
    "        # ë‘ ë²ˆì§¸ ì§ˆë¬¸ (ìƒì„±ëœ ì„¸ì…˜ ID ì‚¬ìš©)\n",
    "        query2 = \"ê·¸ê²ƒì˜ ì¥ì ì€ ë¬´ì—‡ì¸ê°€ìš”?\"\n",
    "        print(f\"ğŸ‘¤ ì§ˆë¬¸ 2: {query2}\")\n",
    "        \n",
    "        result2 = bedrock_client.retrieve_and_generate(query2, session_id)\n",
    "        print(f\"ğŸ¤– ë‹µë³€ 2: {result2['answer'][:200]}...\\n\")\n",
    "        \n",
    "        print(\"âœ… ëŒ€í™” ì„¸ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ\")\n",
    "    else:\n",
    "        print(\"âš ï¸ ì„¸ì…˜ IDê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\")\n",
    "else:\n",
    "    print(\"âš ï¸ Knowledge Base IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ì„¸ì…˜ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.\")\n",
    "\n",
    "# Knowledge Base í…ŒìŠ¤íŠ¸ ì‹¤í–‰\n",
    "def test_knowledge_base():\n",
    "    \"\"\"ì—…ë¡œë“œëœ í…ŒìŠ¤íŠ¸ ë¬¸ì„œë¡œ Knowledge Base ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸\"\"\"\n",
    "    \n",
    "    test_queries = [\n",
    "        \"RAG ì‹œìŠ¤í…œì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.\",\n",
    "        \"RAGì˜ ì£¼ìš” ì¥ì ì€ ë¬´ì—‡ì¸ê°€ìš”?\",\n",
    "        \"AWS Bedrockì˜ Foundation Modelì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆë‚˜ìš”?\",\n",
    "        \"ë©€í‹°ëª¨ë‹¬ ë¬¸ì„œ ì²˜ë¦¬ ê³¼ì •ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”.\"\n",
    "    ]\n",
    "    \n",
    "    print(\"\\nğŸ§ª Knowledge Base í…ŒìŠ¤íŠ¸ ì‹œì‘...\\n\")\n",
    "    \n",
    "    for i, query in enumerate(test_queries, 1):\n",
    "        print(f\"ğŸ‘¤ ì§ˆë¬¸ {i}: {query}\")\n",
    "        \n",
    "        try:\n",
    "            # RAG ê²€ìƒ‰ ì‹¤í–‰\n",
    "            result = bedrock_client.retrieve_and_generate(query)\n",
    "            \n",
    "            # ê²°ê³¼ ì¶œë ¥\n",
    "            print(f\"ğŸ¤– ë‹µë³€ {i}: {result['answer'][:100]}...\")\n",
    "            \n",
    "            if result.get('sources'):\n",
    "                print(f\"ğŸ“š ì°¸ì¡° ì†ŒìŠ¤: {len(result['sources'])}ê°œ ë°œê²¬\")\n",
    "                for j, source in enumerate(result['sources'][:2], 1):  # ìƒìœ„ 2ê°œë§Œ í‘œì‹œ\n",
    "                    filename = source.get('filename', 'Unknown')\n",
    "                    print(f\"   {j}. {filename}\")\n",
    "            else:\n",
    "                print(\"ğŸ“š ì°¸ì¡° ì†ŒìŠ¤: ì—†ìŒ\")\n",
    "                \n",
    "            print(\"-\"*50)\n",
    "            \n",
    "        except Exception as e:\n",
    "            print(f\"âŒ í…ŒìŠ¤íŠ¸ {i} ì‹¤íŒ¨: {e}\")\n",
    "            print(\"-\"*50)\n",
    "    \n",
    "    print(\"\\nâœ… Knowledge Base í…ŒìŠ¤íŠ¸ ì™„ë£Œ\")\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ì‹¤í–‰\n",
    "if kb_id and 'sync_success' in locals() and sync_success:\n",
    "    test_knowledge_base()\n",
    "else:\n",
    "    print(\"\\nâš ï¸ Knowledge Baseê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•„ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.\")\n",
    "    print(\"5ë²ˆ ì„¹ì…˜ì„ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³  ë™ê¸°í™”í•˜ì„¸ìš”.\")\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì •ë¦¬ (Knowledge Baseë¥¼ ë¹ˆ ìƒíƒœë¡œ ë³µì›)\n",
    "def cleanup_test_documents():\n",
    "    \"\"\"í…ŒìŠ¤íŠ¸ ë¬¸ì„œë“¤ì„ S3ì—ì„œ ì‚­ì œí•˜ê³  Knowledge Base ì¬ë™ê¸°í™”\"\"\"\n",
    "    \n",
    "    print(\"\\nğŸ§¹ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì •ë¦¬ ì‹œì‘...\")\n",
    "    \n",
    "    # S3ì—ì„œ í…ŒìŠ¤íŠ¸ ë¬¸ì„œë“¤ ì‚­ì œ\n",
    "    deleted_files = []\n",
    "    \n",
    "    if 'test_files' in locals():\n",
    "        for filename in test_files:\n",
    "            try:\n",
    "                s3_client.delete_object(\n",
    "                    Bucket=s3_bucket_name,\n",
    "                    Key=f'documents/{filename}'\n",
    "                )\n",
    "                deleted_files.append(filename)\n",
    "                print(f\"ğŸ—‘ï¸ {filename} ì‚­ì œ ì™„ë£Œ\")\n",
    "                \n",
    "            except Exception as e:\n",
    "                print(f\"âŒ {filename} ì‚­ì œ ì‹¤íŒ¨: {e}\")\n",
    "    else:\n",
    "        print(\"âš ï¸ ì‚­ì œí•  í…ŒìŠ¤íŠ¸ íŒŒì¼ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\")\n",
    "        return\n",
    "    \n",
    "    print(f\"\\nğŸ“Š ì´ {len(deleted_files)}ê°œ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ\")\n",
    "    \n",
    "    # Knowledge Base ì¬ë™ê¸°í™” (ë¹ˆ ìƒíƒœë¡œ)\n",
    "    if deleted_files and kb_id and data_source_id:\n",
    "        print(\"\\nğŸ”„ Knowledge Base ì¬ë™ê¸°í™” ì‹œì‘ (ë¹ˆ ìƒíƒœë¡œ ë³µì›)...\")\n",
    "        \n",
    "        try:\n",
    "            # ìƒˆë¡œìš´ Ingestion Job ì‹œì‘\n",
    "            response = bedrock_agent_client.start_ingestion_job(\n",
    "                knowledgeBaseId=kb_id,\n",
    "                dataSourceId=data_source_id,\n",
    "                description='Cleanup - Remove test documents'\n",
    "            )\n",
    "            \n",
    "            job_id = response['ingestionJob']['ingestionJobId']\n",
    "            print(f\"ğŸ“‹ ì •ë¦¬ Job ID: {job_id}\")\n",
    "            \n",
    "            # Job ì™„ë£Œ ëŒ€ê¸° (ê°„ë‹¨ ë²„ì „)\n",
    "            print(\"â³ ì •ë¦¬ ì‘ì—… ì§„í–‰ ì¤‘...\")\n",
    "            time.sleep(30)  # 30ì´ˆ ëŒ€ê¸°\n",
    "            \n",
    "            # ìµœì¢… ìƒíƒœ í™•ì¸\n",
    "            final_status = bedrock_agent_client.get_ingestion_job(\n",
    "                knowledgeBaseId=kb_id,\n",
    "                dataSourceId=data_source_id,\n",
    "                ingestionJobId=job_id\n",
    "            )\n",
    "            \n",
    "            status = final_status['ingestionJob']['status']\n",
    "            print(f\"ğŸ“Š ìµœì¢… ìƒíƒœ: {status}\")\n",
    "            \n",
    "            if status == 'COMPLETE':\n",
    "                print(\"âœ… Knowledge Base ì •ë¦¬ ì™„ë£Œ! ì´ì œ ë¹ˆ ìƒíƒœì…ë‹ˆë‹¤.\")\n",
    "            else:\n",
    "                print(f\"âš ï¸ ì •ë¦¬ ì‘ì—…ì´ ì•„ì§ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ìƒíƒœ: {status}\")\n",
    "                \n",
    "        except Exception as e:\n",
    "            print(f\"âŒ ì¬ë™ê¸°í™” ì˜¤ë¥˜: {e}\")\n",
    "    \n",
    "    print(\"\\nğŸ‰ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì •ë¦¬ ì™„ë£Œ!\")\n",
    "    print(\"ğŸ’¡ Knowledge Baseê°€ ì›ë˜ ë¹ˆ ìƒíƒœë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.\")\n",
    "\n",
    "# ì •ë¦¬ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸\n",
    "print(\"\\nğŸ¤” í…ŒìŠ¤íŠ¸ ë¬¸ì„œë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\")\n",
    "print(\"y: ì •ë¦¬ ì‹¤í–‰ (Knowledge Baseë¥¼ ë¹ˆ ìƒíƒœë¡œ ë³µì›)\")\n",
    "print(\"n: ì •ë¦¬ ê±´ë„ˆë›°ê¸° (í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìœ ì§€)\")\n",
    "\n",
    "cleanup_choice = input(\"ì„ íƒ (y/N): \")\n",
    "\n",
    "if cleanup_choice.lower() in ['y', 'yes']:\n",
    "    cleanup_test_documents()\n",
    "else:\n",
    "    print(\"ğŸ“ í…ŒìŠ¤íŠ¸ ë¬¸ì„œê°€ Knowledge Baseì— ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.\")\n",
    "    print(\"ğŸ’¡ ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ì •ë¦¬í•˜ê±°ë‚˜ ì´ ì…€ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 7. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def format_sources(sources: List[Dict[str, Any]]) -> str:\n",
    "    \"\"\"\n",
    "    ì†ŒìŠ¤ ì •ë³´ë¥¼ ì‚¬ìš©ì ì¹œí™”ì  í˜•íƒœë¡œ í¬ë§·íŒ…\n",
    "    \n",
    "    Args:\n",
    "        sources: ì†ŒìŠ¤ ì •ë³´ ë¦¬ìŠ¤íŠ¸\n",
    "        \n",
    "    Returns:\n",
    "        í¬ë§·íŒ…ëœ ì†ŒìŠ¤ ë¬¸ìì—´\n",
    "    \"\"\"\n",
    "    if not sources:\n",
    "        return \"ì°¸ì¡° ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.\"\n",
    "    \n",
    "    formatted = []\n",
    "    for i, source in enumerate(sources, 1):\n",
    "        filename = source.get('filename', 'Unknown File')\n",
    "        content = source.get('content', '')[:150] + '...' if len(source.get('content', '')) > 150 else source.get('content', '')\n",
    "        \n",
    "        formatted.append(f\"{i}. **{filename}**\\n   {content}\")\n",
    "    \n",
    "    return \"\\n\\n\".join(formatted)\n",
    "\n",
    "def create_chat_response(query: str, bedrock_client: BedrockClient, session_id: str = None) -> Dict[str, Any]:\n",
    "    \"\"\"\n",
    "    ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ìš© ì‘ë‹µ ìƒì„±\n",
    "    \n",
    "    Args:\n",
    "        query: ì‚¬ìš©ì ì§ˆë¬¸\n",
    "        bedrock_client: BedrockClient ì¸ìŠ¤í„´ìŠ¤\n",
    "        session_id: ì„¸ì…˜ ID\n",
    "        \n",
    "    Returns:\n",
    "        ì±„íŒ…ìš© ì‘ë‹µ ë°ì´í„°\n",
    "    \"\"\"\n",
    "    result = bedrock_client.retrieve_and_generate(query, session_id)\n",
    "    \n",
    "    return {\n",
    "        'query': query,\n",
    "        'answer': result['answer'],\n",
    "        'sources_formatted': format_sources(result.get('sources', [])),\n",
    "        'sources_count': len(result.get('sources', [])),\n",
    "        'session_id': result.get('session_id'),\n",
    "        'timestamp': result.get('timestamp'),\n",
    "        'has_error': result.get('error', False)\n",
    "    }\n",
    "\n",
    "print(\"âœ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 8. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ í…ŒìŠ¤íŠ¸"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "if kb_id:\n",
    "    # ì±„íŒ… ì‘ë‹µ í…ŒìŠ¤íŠ¸\n",
    "    test_query = \"ë©€í‹°ëª¨ë‹¬ RAG ì‹œìŠ¤í…œì˜ íŠ¹ì§•ì„ ì•Œë ¤ì£¼ì„¸ìš”.\"\n",
    "    \n",
    "    print(f\"ğŸ§ª ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ í…ŒìŠ¤íŠ¸\")\n",
    "    print(f\"ì§ˆë¬¸: {test_query}\\n\")\n",
    "    \n",
    "    chat_response = create_chat_response(test_query, bedrock_client)\n",
    "    \n",
    "    print(\"ğŸ“‹ ì±„íŒ… ì‘ë‹µ êµ¬ì¡°:\")\n",
    "    print(f\"  - ë‹µë³€ ê¸¸ì´: {len(chat_response['answer'])} ë¬¸ì\")\n",
    "    print(f\"  - ì†ŒìŠ¤ ê°œìˆ˜: {chat_response['sources_count']}ê°œ\")\n",
    "    print(f\"  - ì„¸ì…˜ ID: {chat_response['session_id']}\")\n",
    "    print(f\"  - ì˜¤ë¥˜ ì—¬ë¶€: {chat_response['has_error']}\")\n",
    "    \n",
    "    print(\"\\nğŸ“š í¬ë§·íŒ…ëœ ì†ŒìŠ¤:\")\n",
    "    print(chat_response['sources_formatted'])\n",
    "    \n",
    "else:\n",
    "    print(\"âš ï¸ Knowledge Base IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìœ í‹¸ë¦¬í‹° í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 9. ëª¨ë“ˆ ì €ì¥ (ì„ íƒì‚¬í•­)\n",
    "\n",
    "ê°œë°œì´ ì™„ë£Œë˜ë©´ ì´ ì½”ë“œë¥¼ `src/bedrock_client.py`ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# ëª¨ë“ˆë¡œ ì €ì¥í•˜ê¸° (ì„ íƒì‚¬í•­)\n",
    "save_as_module = False  # Trueë¡œ ë³€ê²½í•˜ë©´ ì €ì¥ë¨\n",
    "\n",
    "if save_as_module:\n",
    "    module_code = '''\n",
    "import boto3\n",
    "import json\n",
    "import os\n",
    "from typing import Dict, List, Optional, Any\n",
    "from botocore.exceptions import ClientError\n",
    "import logging\n",
    "from datetime import datetime\n",
    "\n",
    "logger = logging.getLogger(__name__)\n",
    "\n",
    "class BedrockClient:\n",
    "    \"\"\"AWS Bedrockì„ í™œìš©í•œ RAG í´ë¼ì´ì–¸íŠ¸\"\"\"\n",
    "    \n",
    "    def __init__(self, region_name: str = 'us-west-2', knowledge_base_id: str = None, model_id: str = None):\n",
    "        # ... (ìœ„ì˜ í´ë˜ìŠ¤ ì½”ë“œì™€ ë™ì¼)\n",
    "        pass\n",
    "    \n",
    "    # ... ë‚˜ë¨¸ì§€ ë©”ì„œë“œë“¤\n",
    "'''\n",
    "    \n",
    "    with open('src/bedrock_client.py', 'w', encoding='utf-8') as f:\n",
    "        f.write(module_code)\n",
    "    \n",
    "    print(\"âœ… src/bedrock_client.py íŒŒì¼ë¡œ ì €ì¥ ì™„ë£Œ\")\n",
    "else:\n",
    "    print(\"ğŸ’¡ save_as_module = Trueë¡œ ì„¤ì •í•˜ë©´ ëª¨ë“ˆ íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„\n",
    "\n",
    "1. **ë¬¸ì„œ ì²˜ë¦¬ ëª¨ë“ˆ**: `03_document_processor.ipynb` ìƒì„±\n",
    "2. **Knowledge Base ì—°ë™**: `04_knowledge_base.ipynb` ìƒì„±\n",
    "3. **Streamlit UI**: `06_streamlit_basic.ipynb` ìƒì„±\n",
    "\n",
    "## ğŸ“ ì°¸ê³ ì‚¬í•­\n",
    "\n",
    "- Knowledge Baseì— ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ì˜ë¯¸ìˆëŠ” ë‹µë³€ì„ ë°›ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n",
    "- ì„¸ì…˜ IDë¥¼ ì‚¬ìš©í•˜ë©´ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ê°€ ìœ ì§€ë©ë‹ˆë‹¤.\n",
    "- ì—ëŸ¬ ì²˜ë¦¬ê°€ í¬í•¨ë˜ì–´ ìˆì–´ ì•ˆì •ì ì¸ ìš´ì˜ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.23"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
